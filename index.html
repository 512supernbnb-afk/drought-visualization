<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°£è±¡æŒ‡æ¨™æ³•ä¹¾æ—±åˆ†æ</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --rain-color: #3498db;
            --drought-color: #e74c3c;
            --highlight: #f39c12; /* é«˜äº®é¡è‰² */
            --bg: #f8f9fa;
        }
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg);
            color: var(--primary);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* æ¨™é¡Œå€åŸŸ */
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #ddd;
            padding-bottom: 20px;
        }
        h1 { margin: 0; font-size: 2.2em; color: var(--primary); }
        .subtitle {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            background: #eee;
            display: inline-block;
            padding: 8px 15px;
            border-radius: 5px;
            line-height: 1.5;
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        select {
            padding: 8px;
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .slider-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
        }
        input[type=range] {
            flex-grow: 1;
            cursor: pointer;
        }
        #current-year-display {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary);
            min-width: 80px;
        }

        /* åœ–è¡¨å€å¡Š */
        .chart-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            min-height: 450px;
        }

        /* åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .toggle-btn-group {
            display: flex;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }
        .toggle-btn {
            padding: 8px 16px;
            border: none;
            background: #f1f1f1;
            cursor: pointer;
            transition: 0.3s;
            font-weight: bold;
        }
        .toggle-btn.active {
            color: white;
        }
        .toggle-btn.active.drought { background: var(--drought-color); }
        .toggle-btn.active.rain { background: var(--rain-color); }

        .loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
            font-size: 1.5em;
            display: none;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loading">è³‡æ–™è®€å–é‹ç®—ä¸­...</div>

<div class="container">
    <header>
        <h1>æ°£è±¡æŒ‡æ¨™æ³•ä¹¾æ—±åˆ†æ</h1>
        <div class="subtitle">
            âš ï¸ å‚™è¨»ï¼šæœ¬åˆ†æåƒ…è€ƒæ…®é™é›¨é‡æ•¸æ“šï¼Œæœªä½¿ç”¨æ°´è³‡æºèª¿åº¦åŠæ°´åº«æ°´ä½è³‡æ–™ã€‚<br>
            æ‰€è¨ˆç®—ä¹‹ä¹¾æ—±æŒ‡æ¨™èˆ‡å¼·åº¦åƒ…ä¾›å­¸è¡“ç ”ç©¶åƒè€ƒï¼Œéä»£è¡¨æ°´åˆ©ç½²å…¬å‘Šä¹‹æ­£å¼æ°´åˆ©ç½å®³ã€‚
        </div>
    </header>

    <div class="controls">
        <div class="control-group">
            <label for="station-select">ğŸ“ é¸æ“‡æ¸¬ç«™ï¼š</label>
            <select id="station-select">
                <option value="./data/å¤§æ¹–å±±_é›¨é‡æ—¥è³‡æ–™.json">å¤§æ¹–å±±æ¸¬ç«™</option>
                <option value="./data/å°å…¬ç”°(2)_é›¨é‡æ—¥è³‡æ–™.json">å°å…¬ç”°æ¸¬ç«™</option>
                </select>
        </div>

        <div class="slider-container">
            <label>ğŸ“… åˆ†æå¹´ä»½ï¼š</label>
            <input type="range" id="year-slider" min="1900" max="2024" step="1">
            <span id="current-year-display">--</span>
        </div>
    </div>

    <div class="chart-box" id="main-chart"></div>

    <div class="chart-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin:0;">æ­·å¹´çµ±è¨ˆæ¦‚æ³</h3>
            <div class="toggle-btn-group">
                <button class="toggle-btn active drought" onclick="setBarMode('drought')">ğŸ”¥ ä¹¾æ—±å¤©æ•¸</button>
                <button class="toggle-btn" onclick="setBarMode('rain')">ğŸ’§ å¹´ç¸½é›¨é‡</button>
            </div>
        </div>
        <div id="summary-chart"></div>
    </div>
</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let globalData = {
        dailyData: [],
        cuttingLevel: [], // 1-366 çš„é–¾å€¼
        yearlyStats: [],
        years: []
    };
    let currentBarMode = 'drought'; // 'drought' or 'rain'

    // --- åˆå§‹åŒ– ---
    window.addEventListener('DOMContentLoaded', () => {
        const select = document.getElementById('station-select');
        // è¼‰å…¥é è¨­é¸å–®çš„ç¬¬ä¸€å€‹æ¸¬ç«™
        loadStationData(select.value);

        // ç›£è½é¸å–®è®Šæ›´
        select.addEventListener('change', (e) => {
            loadStationData(e.target.value);
        });

        // ç›£è½æ»‘æ¡¿è®Šæ›´
        document.getElementById('year-slider').addEventListener('input', (e) => {
            updateDashboard(parseInt(e.target.value));
        });
    });

    // --- 1. è³‡æ–™è®€å– (Fetch) ---
    async function loadStationData(url) {
        const loading = document.getElementById('loading');
        loading.style.display = 'flex';
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("HTTP error " + response.status);
            const jsonData = await response.json();
            
            processData(jsonData);
            setupSlider();
            
            // é è¨­é¡¯ç¤ºæœ€æ–°å¹´ä»½
            const lastYear = globalData.years[globalData.years.length - 1];
            document.getElementById('year-slider').value = lastYear;
            updateDashboard(lastYear);

        } catch (error) {
            console.error(error);
            alert("è®€å–è³‡æ–™å¤±æ•—ï¼\n\nè«‹ç¢ºèªï¼š\n1. æ‚¨æ˜¯å¦ä½¿ç”¨äº† Web Server (å¦‚ Live Server) é–‹å•Ÿç¶²é ï¼Ÿ\n2. './data/' è³‡æ–™å¤¾ä¸‹æ˜¯å¦æœ‰å°æ‡‰çš„ JSON æª”ï¼Ÿ");
        } finally {
            loading.style.display = 'none';
        }
    }

    // --- 2. æ ¸å¿ƒé‹ç®—é‚è¼¯ (ç§»æ¤ R Code) ---
    function processData(rawData) {
        // A. è³‡æ–™æ¸…ç† & 30æ—¥ Roll Sum
        const cleanData = rawData.map(d => {
            const dateStr = d.yymmdd.split(' ')[0];
            const dateParts = dateStr.split('/');
            const dateObj = new Date(dateParts[0], dateParts[1]-1, dateParts[2]);
            
            const start = new Date(dateObj.getFullYear(), 0, 0);
            const diff = dateObj - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const doy = Math.floor(diff / oneDay);

            return {
                date: dateObj,
                dateStr: dateStr,
                year: dateObj.getFullYear(),
                doy: doy,
                rainfall: d.DAVG === null ? 0 : parseFloat(d.DAVG),
                rollSum: null
            };
        }).sort((a, b) => a.date - b.date);

        // è¨ˆç®— 30æ—¥ç´¯ç©
        for (let i = 0; i < cleanData.length; i++) {
            if (i < 29) {
                cleanData[i].rollSum = null;
            } else {
                let sum = 0;
                for (let j = 0; j < 30; j++) sum += cleanData[i - j].rainfall;
                cleanData[i].rollSum = sum;
            }
        }

        // B. è¨ˆç®— Cutting Level (æ­·å² 20% åˆ†ä½æ•¸)
        const doyBuckets = Array.from({length: 367}, () => []);
        cleanData.forEach(d => {
            if (d.rollSum !== null) doyBuckets[d.doy].push(d.rollSum);
        });

        const cuttingLevels = {};
        for (let i = 1; i <= 366; i++) {
            const values = doyBuckets[i];
            if (values.length > 0) {
                values.sort((a, b) => a - b);
                const idx = Math.floor(values.length * 0.2); // Quantile 0.2
                cuttingLevels[i] = values[idx];
            } else {
                cuttingLevels[i] = 0;
            }
        }

        // C. è¨ˆç®—æ­·å¹´çµ±è¨ˆ (ä¹¾æ—±å¤©æ•¸ & ç¸½é›¨é‡)
        const yearSet = new Set(cleanData.map(d => d.year));
        const years = Array.from(yearSet).sort((a, b) => a - b);
        const yearlyStats = [];

        years.forEach(yr => {
            const yearRecords = cleanData.filter(d => d.year === yr);
            
            // 1. ç¸½é›¨é‡
            const totalRain = yearRecords.reduce((sum, d) => sum + d.rainfall, 0);

            // 2. ä¹¾æ—±å¤©æ•¸ (ä¾æ“š Cutting Level)
            let droughtDays = 0;
            yearRecords.forEach(d => {
                if (d.rollSum !== null) {
                    const threshold = cuttingLevels[d.doy];
                    if (d.rollSum < threshold) droughtDays++;
                }
            });

            yearlyStats.push({ 
                year: yr, 
                droughtDays: droughtDays, 
                totalRain: totalRain 
            });
        });

        globalData.dailyData = cleanData;
        globalData.cuttingLevel = cuttingLevels;
        globalData.yearlyStats = yearlyStats;
        globalData.years = years;
    }

    function setupSlider() {
        const slider = document.getElementById('year-slider');
        slider.min = globalData.years[0];
        slider.max = globalData.years[globalData.years.length - 1];
    }

    // --- 3. è¦–è¦ºåŒ–æ›´æ–° ---
    function updateDashboard(selectedYear) {
        document.getElementById('current-year-display').innerText = selectedYear;
        
        renderMainChart(selectedYear);
        renderBarChart(selectedYear);
    }

    function renderMainChart(year) {
        const yearData = globalData.dailyData.filter(d => d.year === year);
        
        // ã€ä¿®æ”¹é» 1ã€‘é€™è£¡æ”¹æˆ d.date (æ—¥æœŸç‰©ä»¶)ï¼Œè€Œä¸æ˜¯ d.dateStr (æ–‡å­—)
        // é€™æ¨£ Plotly æ‰èƒ½æŠŠå®ƒç•¶ä½œæ™‚é–“è»¸ä¾†è‡ªå‹•ç¸®æ”¾ï¼Œä¸æœƒå…¨éƒ¨æ“ åœ¨ä¸€èµ·
        const x_axis = yearData.map(d => d.date); 
        
        const y_rain = yearData.map(d => d.rollSum);
        const y_cut = yearData.map(d => globalData.cuttingLevel[d.doy]);

        // åµæ¸¬ä¹¾æ—±äº‹ä»¶ (ç”¢ç”Ÿ Shape èˆ‡ Annotation)
        const shapes = [];
        const annotations = [];
        let inDrought = false;
        let eventStart = null;
        let eventMagnitude = 0; 

        const closeEvent = (endIndex) => {
            if (eventMagnitude > 0) {
                shapes.push({
                    type: 'rect',
                    // å› ç‚º x_axis ç¾åœ¨æ˜¯æ—¥æœŸç‰©ä»¶ï¼Œé€™è£¡ä¹Ÿè¦ç”¨æ—¥æœŸ
                    x0: x_axis[eventStart], x1: x_axis[endIndex],
                    xref: 'x', yref: 'paper',
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(231, 76, 60, 0.2)',
                    line: { width: 0 }
                });

                const midIndex = Math.floor((eventStart + endIndex) / 2);
                annotations.push({
                    x: x_axis[midIndex],
                    y: y_cut[midIndex],
                    xref: 'x', yref: 'y',
                    text: `D=${Math.round(eventMagnitude)}`,
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0, ay: -20,
                    font: {color: '#c0392b', size: 12}
                });
            }
            inDrought = false;
            eventMagnitude = 0;
        };

        for (let i = 0; i < yearData.length; i++) {
            const val = y_rain[i];
            const cut = y_cut[i];
            
            if (val !== null && val < cut) {
                if (!inDrought) {
                    inDrought = true;
                    eventStart = i;
                }
                eventMagnitude += (cut - val); 
            } else {
                if (inDrought) closeEvent(i - 1);
            }
        }
        if (inDrought) closeEvent(yearData.length - 1);


        const traceRain = {
            x: x_axis, y: y_rain,
            mode: 'lines', name: '30æ—¥é›¨é‡',
            line: { color: '#3498db', width: 2.5 }
        };

        const traceCut = {
            x: x_axis, y: y_cut,
            mode: 'lines', name: 'Cutting Level (20%)',
            line: { color: '#e74c3c', dash: 'dash', width: 2 }
        };

        const layout = {
            title: { text: `${year} å¹´é™é›¨èˆ‡ä¹¾æ—±äº‹ä»¶åˆ†æ (D=ä¹¾æ—±é‡ mmâ‹…day)`, font: {size: 18} },
            xaxis: { 
                title: 'æ—¥æœŸ',
                // ã€ä¿®æ”¹é» 2ã€‘è¨­å®šæ—¥æœŸæ ¼å¼
                tickformat: '%m/%d', // åªé¡¯ç¤º æœˆ/æ—¥
                dtick: "M1",         // å¼·åˆ¶æ¯å€‹æœˆé¡¯ç¤ºä¸€å€‹åˆ»åº¦ (å¯é¸ï¼Œè‹¥è¦ºå¾—é‚„å¤ªæ“ å¯æ‹¿æ‰é€™è¡Œ)
                hoverformat: '%Y/%m/%d' // æ»‘é¼ ç§»ä¸Šå»æ™‚é¡¯ç¤ºå®Œæ•´æ—¥æœŸ
            },
            yaxis: { title: 'é›¨é‡ (mm)' },
            shapes: shapes,
            annotations: annotations,
            hovermode: 'x unified',
            margin: { t: 50, b: 50, l: 60, r: 20 },
            legend: { orientation: "h", y: 1.1 }
        };

        Plotly.newPlot('main-chart', [traceRain, traceCut], layout);
    }
    // --- é•·æ¢åœ–åˆ‡æ›åŠŸèƒ½ ---
    function setBarMode(mode) {
        currentBarMode = mode;
        
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active', 'drought', 'rain'));
        const activeBtn = event.target;
        activeBtn.classList.add('active');
        if(mode === 'drought') activeBtn.classList.add('drought');
        if(mode === 'rain') activeBtn.classList.add('rain');

        // é‡æ–°ç¹ªè£½é•·æ¢åœ–
        const currentYear = parseInt(document.getElementById('year-slider').value);
        renderBarChart(currentYear);
    }

    function renderBarChart(highlightYear) {
        const x_years = globalData.yearlyStats.map(d => d.year);
        
        let y_values, title, y_label, baseColor;
        
        if (currentBarMode === 'drought') {
            y_values = globalData.yearlyStats.map(d => d.droughtDays);
            title = 'æ­·å¹´ä¹¾æ—±å¤©æ•¸çµ±è¨ˆ (å¤©æ•¸æ„ˆå¤šæ„ˆä¹¾æ—±)';
            y_label = 'ä½æ–¼é–¾å€¼å¤©æ•¸';
            baseColor = '#bdc3c7'; // ç°è‰²
        } else {
            y_values = globalData.yearlyStats.map(d => d.totalRain);
            title = 'æ­·å¹´ç¸½é™é›¨é‡çµ±è¨ˆ (é›¨é‡æ„ˆå°‘æ„ˆä¹¾æ—±)';
            y_label = 'å¹´ç¸½é›¨é‡ (mm)';
            baseColor = '#aed6f1'; // æ·ºè—è‰²
        }

        // å‹•æ…‹é¡è‰² highlight
        const colors = x_years.map(yr => {
            if (yr === highlightYear) return '#f39c12'; // é«˜äº®æ©˜è‰²
            return baseColor;
        });

        const trace = {
            x: x_years,
            y: y_values,
            type: 'bar',
            marker: { color: colors }
        };

        const layout = {
            title: title,
            xaxis: { title: 'å¹´ä»½' },
            yaxis: { title: y_label },
            margin: { t: 40, b: 40, l: 60, r: 20 }
        };

        Plotly.newPlot('summary-chart', [trace], layout);
    }
</script>

</body>

</html>


